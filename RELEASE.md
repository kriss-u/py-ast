# Release Guide

This project uses automated releases for npm and manual releases for JSR.

## Automated npm Releases (via semantic-release)

The project uses [semantic-release](https://semantic-release.gitbook.io/) for automated npm releases based on conventional commits.

### How it works:
1. **Conventional Commits**: Use conventional commit messages (already configured with commitlint)
2. **Automatic Versioning**: semantic-release analyzes commit messages to determine version bumps:
   - `fix:` → patch release (1.0.1)
   - `feat:` → minor release (1.1.0)
   - `feat!:` or `BREAKING CHANGE:` → major release (2.0.0)
3. **Automatic Publishing**: Releases are triggered on pushes to `main` branch

### Commit Message Examples:
```bash
# Patch release
git commit -m "fix: resolve parsing issue with async functions"

# Minor release  
git commit -m "feat: add support for Python 3.12 syntax"

# Major release
git commit -m "feat!: change parser API to return structured errors"
# or
git commit -m "feat: redesign parser API

BREAKING CHANGE: Parser now returns structured errors instead of throwing exceptions"
```

### Testing Releases:
```bash
# Dry run to see what would be released
npm run release:dry
```

### Manual Release (if needed):
```bash
npm run release
```

## Manual JSR Releases

JSR releases are done manually after npm releases.

### Steps:
1. **Sync versions**: After a semantic-release, sync the version to jsr.json:
   ```bash
   npm run jsr:sync
   ```

2. **Build the project**:
   ```bash
   npm run build
   ```

3. **Publish to JSR**:
   ```bash
   npx jsr publish
   # or if you have JSR CLI installed globally:
   # jsr publish
   ```

## Setup for New Contributors

### GitHub Repository Settings:
1. Go to Settings → Secrets and variables → Actions
2. Add `NPM_TOKEN`: Your npm automation token (with publish permissions)

### npm Token Setup:
1. Login to npm: `npm login`
2. Create automation token: `npm token create --type=automation`
3. Add token to GitHub secrets as `NPM_TOKEN`

### Branch Protection (Recommended):
1. Go to Settings → Branches
2. Add protection rule for `main` branch:
   - Require pull request reviews
   - Require status checks (tests)
   - Require conversation resolution before merging

## Release Workflow

### For Regular Development:
1. Create feature branch: `git checkout -b feature/my-feature`
2. Make changes with conventional commits
3. Open PR to `main`
4. After merge, semantic-release will automatically:
   - Determine version bump
   - Generate changelog
   - Create GitHub release
   - Publish to npm

### For JSR Releases:
1. After npm release is published, run:
   ```bash
   npm run jsr:sync
   npm run build
   npx jsr publish
   ```

## Branches

- **main**: Production releases (automatically published to npm)
- **beta**: Beta releases (prerelease versions)

## Generated Files

The following files are automatically generated/updated:
- `CHANGELOG.md`: Generated by semantic-release
- `package.json`: Version bumped by semantic-release
- GitHub releases: Created automatically

## Troubleshooting

### semantic-release fails:
- Check commit message format
- Ensure GitHub token has correct permissions
- Verify npm token is valid

### JSR publish fails:
- Ensure you're logged into JSR: `npx jsr auth`
- Check jsr.json configuration
- Verify build outputs are present
